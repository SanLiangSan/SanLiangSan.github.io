<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    
    sanliangsan的博客</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="sanliangsan的博客" type="application/atom+xml">
</head>

<body>
<main class="content">
  <section class="jumbotron">
  <div class="video">
    
      <div class="video-frame">
        <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
      </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay=""
             poster="/images/ocean/ocean.png" x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">sanliangsan的博客</a></h1>
      <p>不抛弃，不放弃</p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="sanliangsan的博客"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>

<div id="landingpage">
  <section class="outer">
    <article class="articles">
      
      <h1 class="page-type-title"></h1>
      
        
          <article id="post-Dispatch-Source之自定义Time" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2020/03/01/Dispatch-Source%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89Time/">Dispatch Source之自定义Time</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/03/01/Dispatch-Source%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89Time/" class="article-date">
  <time datetime="2020-03-01T13:59:13.000Z" itemprop="datePublished">2020-03-01</time>
</a>
                            
                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding: 10px; word-spacing: 0px; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif; line-height: 1.6; letter-spacing: .034em; color: rgb(63, 63, 63); font-size: 16px; word-break: all;"><figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px;"><img src="https://user-gold-cdn.xitu.io/2020/2/28/1708c240b3b6e038?w=900&amp;h=383&amp;f=jpeg&amp;s=195354" alt style="display: block; margin: 0 auto; width: 100%; border-radius: 4px; margin-bottom: 25px;"></figure>
<h2 data-tool="mdnice编辑器" style="font-weight: bold; color: black; font-size: 24px; display: block; text-align: center; background-image: url(https://my-wechat.mdnice.com/mdnice/mountain_2_20191028221337.png); background-position: center center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 63px; margin-top: 38px; margin-bottom: 10px;"><span style="text-align: center; display: inline-block; height: 38px; line-height: 42px; color: rgb(60, 112, 198); background-position: left center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 63px; margin-top: 38px; font-size: 18px; margin-bottom: 10px;">1、How about NSTimer?</span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>可能大家都熟悉，他的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">api</code>也都很简单，但是其使用过程并不容易，相信用过的同学都踩过坑.通常我们这么用:</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">// 定义
</span>
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@property</span> (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">nonatomic</span>, <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">strong</span>) <span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimer</span> *timer;
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">// 使用
</span>
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span>.timer = [<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimer</span> scheduledTimerWithTimeInterval:<span class="hljs-number" style="color: #986801; line-height: 26px;">1</span> target:<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span> selector:<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@selector</span>(demo:) userInfo:<span class="hljs-literal" style="color: #0184bb; line-height: 26px;">nil</span> repeats:<span class="hljs-literal" style="color: #0184bb; line-height: 26px;">YES</span>];
</code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">1.</code> <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timerWithTimeInterval</code>开头的方法需要自己添加到指定的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>中去，而<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">scheduledTimerWithTimeInterval</code>开头的方法默认添加到当前的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>中去.</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">2.</code> 默认添加到<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>中的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>会以<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSDefaultRunLoopMode</code>的模式放入当前的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>,这就导致经常出现的列表滚动<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>停止的问题，因为列表滚动的时候<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">mode</code>切换了，需要我们手动将<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>切换为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">commonMode</code>.</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">3.</code>我们经常会为使用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>出现的内存泄漏而烦恼,即使有解决方案，总感觉很别扭.</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">为什么会内存泄漏呢？我们看一下<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">api</code>的描述</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><img src="https://user-gold-cdn.xitu.io/2020/2/29/17090ddbcf7c9ac2?w=980&amp;h=752&amp;f=png&amp;s=926300" alt style="display: block; margin: 0 auto; width: 100%; border-radius: 4px; margin-bottom: 25px;">
<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>会一直强引用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">target</code>，直到<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>调用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">invalide</code>方法,在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">[timer invalidate]</code>调用之前，<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>和<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">vc</code>构成了<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">循环引用</code>的关系，所以在我们<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">vc</code>在退出当前页面的时候<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dealloc</code>方法并不调用，所以不论我们的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>是<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">strong</code>还是<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">weak</code>都无济于事，因为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">api</code>内部会强持有。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">网上有很多种方案去实现打破这种循环引用来解决内存泄漏问题，这里我们从<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">自定义timer</code>说起,自定义timer说到底就是用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_source</code>这套<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">api</code>去实现.</p>
<h2 data-tool="mdnice编辑器" style="font-weight: bold; color: black; font-size: 24px; display: block; text-align: center; background-image: url(https://my-wechat.mdnice.com/mdnice/mountain_2_20191028221337.png); background-position: center center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 63px; margin-top: 38px; margin-bottom: 10px;"><span style="text-align: center; display: inline-block; height: 38px; line-height: 42px; color: rgb(60, 112, 198); background-position: left center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 63px; margin-top: 38px; font-size: 18px; margin-bottom: 10px;">2、Dispatch Source Timer</span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">Dispatch Source Timer</code> 是一种与<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch queue</code>结合使用的定时器，当需要在后台<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">queue</code>中定期执行任务的时候，使用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch source timer</code> 要比使用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>更自然，更高效（因为无需再<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">main queue</code> 和 异步<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">queue</code>之间切换）。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="background-image: url(https://my-wechat.mdnice.com/mdnice/mountain_1_20191028221337.png); background-size: 15px 15px; display: inline-block; width: 15px; height: 15px; line-height: 15px; margin-bottom: -1px;"></span><span style="font-size: 16px; font-weight: bold; display: inline-block; margin-left: 8px; color: rgb(60,112,198);">2.1 创建timer</span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">官方文档提供创建<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>的示例是：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">dispatch_source_t CreateDispatchTimer(uint64_t interval,
uint64_t leeway,
<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">dispatch_queue_t</span> queue,
dispatch_block_t block)
{
dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER,
<span class="hljs-number" style="color: #986801; line-height: 26px;">0</span>, <span class="hljs-number" style="color: #986801; line-height: 26px;">0</span>, queue);
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (timer)
{
dispatch_source_set_timer(timer, dispatch_walltime(<span class="hljs-literal" style="color: #0184bb; line-height: 26px;">NULL</span>, <span class="hljs-number" style="color: #986801; line-height: 26px;">0</span>), interval, leeway);
dispatch_source_set_event_handler(timer, block);
dispatch_resume(timer);
}
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> timer;
}
</code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">注意点：</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">1.</code> 此处的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>是间隔定时器，每隔一段时间就会触发而不需要像<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>那样设值<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">repeats</code>.</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">2.</code> <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_source_set_timer</code> 中的第二个参数可以传入<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_time</code> 或者 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_walltime</code> ，<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_time</code>表示选择是默认钟表来计时，这个会随着系统休眠而休眠，而 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_walltime</code> 可以让定时间按照实际时间一直运行下去，所以针对间隔时间比较久的定时器应采用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_walltime</code>,上述例子中的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_walltime(NULL, 0)</code> 等同于 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_time(DISPATCH_WALLTIME_NOW, 0)</code>.</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">3.</code> <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_source_set_timer</code> 中的第四个参数leeway 代表的是期望容忍时间，如果设值为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">1</code>，意味着定时器时间达到前一秒或者后一秒才真正触发定时器，计时指定<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">leeway</code>的值为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">0</code>，系统也无法保证完全精确的触发时间，只是尽可能的满足这个需求.</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">4.</code> <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_source_set_event_handler</code> 的参数<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">block</code>代表的是定时器间隔要执行的任务，它是绑定在执行的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">queue</code>上的，这个相比<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>要方便太多，由于<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>需要<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">Runloop</code>支持，<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>则需要手动添加到指定线程的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">runloop</code>中去才能执行.</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="background-image: url(https://my-wechat.mdnice.com/mdnice/mountain_1_20191028221337.png); background-size: 15px 15px; display: inline-block; width: 15px; height: 15px; line-height: 15px; margin-bottom: -1px;"></span><span style="font-size: 16px; font-weight: bold; display: inline-block; margin-left: 8px; color: rgb(60,112,198);">2.2开启 和 停止timer</span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">开启timer的方法：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_resume</code></section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">停止Dispatch Timer有两种方法:</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_suspend</code> :只是暂时把<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>挂起，需要和<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_resume</code>配对使用，在挂起期间，产生的事件会积累，等到<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">resume</code>的时候会整合为一个事件发送.</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">dispatch_source_cancel</code>:相当于<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">invalidate</code>.</section></li></ul>
<h2 data-tool="mdnice编辑器" style="font-weight: bold; color: black; font-size: 24px; display: block; text-align: center; background-image: url(https://my-wechat.mdnice.com/mdnice/mountain_2_20191028221337.png); background-position: center center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 63px; margin-top: 38px; margin-bottom: 10px;"><span style="text-align: center; display: inline-block; height: 38px; line-height: 42px; color: rgb(60, 112, 198); background-position: left center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 63px; margin-top: 38px; font-size: 18px; margin-bottom: 10px;">3、Custom Timer</span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">结合上述的理解，我们尝试自定义<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>，同样我们模仿<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>的接口，这样使用起来没有违和感也更方便:</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@interface</span> <span class="hljs-title" style="color: #c18401; line-height: 26px;">SSTimer</span> : <span class="hljs-title" style="color: #c18401; line-height: 26px;">NSObject</span></span>

<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// 同下面的方法，不过自动开始执行</span>
+ (SSTimer *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)ti target:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">nullable</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)userInfo repeats:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)yesOrNo;
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// 创建一个定时器并返回，但是并不会自动执行，需要手动调用resume方法</span>
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// - parameter:  start 定时器启动时间</span>
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// - parameter:  ti    间隔多久开始执行selector</span>
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// - parameter:  s     执行的任务</span>
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// - parameter:  ui    绑定信息</span>
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// - parameter:  rep   是否重复</span>
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">instancetype</span>)initWithTimeInterval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)start interval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)ti target:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)t selector:(SEL)s userInfo:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">nullable</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)ui repeats:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)rep;

<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// 扩充block</span>
+ (SSTimer *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)interval repeats:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)repeats block:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span> (^)(SSTimer *timer))block;

<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// 启动</span>
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)resume;

<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// 暂定</span>
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)suspend;

<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">
/// 关闭</span>
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)invalidate;
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@property</span> (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">readonly</span>) <span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> repeats;
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@property</span> (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">readonly</span>) <span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span> timeInterval;
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@property</span> (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">readonly</span>, <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">getter</span>=isValid) <span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> valid;
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@property</span> (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">nullable</span>, <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">readonly</span>, <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">retain</span>) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span> userInfo;
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@end</span>
</code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">这里我们提供了启动和暂停的功能，相比<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">NSTimer</code>要好用很多，同时也扩充了<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">block</code>的参数，虽然<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">apple</code>也提供了<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">block</code>的参数方法，但是需要在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">ios10</code>以上的系统上才能使用。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #383a42; background: #fafafa; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-meta" style="color: #4078f2; line-height: 26px;">#import <span class="hljs-meta-string" style="color: #50a14f; line-height: 26px;">"SSTimer.h"</span></span>

<span class="hljs-meta" style="color: #4078f2; line-height: 26px;">
#define lock(...) \</span>
dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);\
__VA_ARGS__;\
dispatch_semaphore_signal(_semaphore);
<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">
@implementation</span> <span class="hljs-title" style="color: #c18401; line-height: 26px;">SSTimer</span> </span>{
<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> _valid;
<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span> _timeInterval;
<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> _repeats;
__<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">weak</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span> _target;
SEL _selector;
dispatch_source_t _timer;
dispatch_semaphore_t _semaphore;
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span> _userInfo;
<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> _running;
}
+ (SSTimer *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)ti target:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">nullable</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)userInfo repeats:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)yesOrNo {
SSTimer *timer = [[SSTimer alloc] initWithTimeInterval:<span class="hljs-number" style="color: #986801; line-height: 26px;">0</span> interval:ti target:aTarget selector:aSelector userInfo:userInfo repeats:yesOrNo];
[timer resume];
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> timer;
}
+ (SSTimer *)scheduledTimerWithTimeInterval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)interval repeats:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)repeats block:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span> (^)(SSTimer *timer))block {
<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSParameterAssert</span>(block != <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">nil</span>);
SSTimer *timer = [[SSTimer alloc] initWithTimeInterval:<span class="hljs-number" style="color: #986801; line-height: 26px;">0</span> interval:interval target:<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span> selector:<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@selector</span>(ss_executeBlockFromTimer:) userInfo:[block <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">copy</span>] repeats:repeats];
[timer resume];
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> timer;
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">instancetype</span>)initWithTimeInterval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)start interval:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)ti target:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)t selector:(SEL)s userInfo:(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">nullable</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)ui repeats:(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)rep {
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span> = [<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">super</span> init];
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span>) {
_valid = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">YES</span>;
_timeInterval = ti;
_repeats = rep;
_target = t;
_selector = s;
_userInfo = ui;
_semaphore = dispatch_semaphore_create(<span class="hljs-number" style="color: #986801; line-height: 26px;">1</span>);
__<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">weak</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">typeof</span>(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span>) weakSelf = <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span>;
_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="hljs-number" style="color: #986801; line-height: 26px;">0</span>, <span class="hljs-number" style="color: #986801; line-height: 26px;">0</span>, dispatch_get_main_queue());
dispatch_source_set_timer(_timer, dispatch_time(DISPATCH_TIME_NOW, start * <span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSEC_PER_SEC</span>), ti * <span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSEC_PER_SEC</span>, <span class="hljs-number" style="color: #986801; line-height: 26px;">0</span>);
dispatch_source_set_event_handler(_timer, ^{[weakSelf fire];});
}
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span>;
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)fire {
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (!_valid) {<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span>;}
lock(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span> target = _target;)
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (!target) {
[<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span> invalidate];
} <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">else</span> {
<span class="hljs-comment" style="color: #a0a1a7; font-style: italic; line-height: 26px;">// 执行selector</span>
<span class="hljs-meta" style="color: #4078f2; line-height: 26px;">#pragma clang diagnostic push</span>
<span class="hljs-meta" style="color: #4078f2; line-height: 26px;">#pragma clang diagnostic ignored <span class="hljs-meta-string" style="color: #50a14f; line-height: 26px;">"-Warc-performSelector-leaks"</span></span>
[target performSelector:_selector withObject:<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span>];
<span class="hljs-meta" style="color: #4078f2; line-height: 26px;">#pragma clang diagnostic pop</span>
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (!_repeats) {
[<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span> invalidate];
}
}
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)resume {
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (_running) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span>;
dispatch_resume(_timer);
_running = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">YES</span>;
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)suspend {
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (!_running) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span>;
dispatch_suspend(_timer);
_running = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">NO</span>;
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)invalidate {
dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (_valid) {
dispatch_source_cancel(_timer);
_timer = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">NULL</span>;
_target = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">nil</span>;
_userInfo = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">nil</span>;
_valid = <span class="hljs-literal" style="color: #0184bb; line-height: 26px;">NO</span>;
}
dispatch_semaphore_signal(_semaphore);
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span>)userInfo {
lock(<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">id</span> ui = _userInfo) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> ui;
}
- (<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)repeats {
lock(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> re = _repeats) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> re;
}
- (<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span>)timeInterval {
lock(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">NSTimeInterval</span> ti = _timeInterval) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> ti;
}
- (<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span>)isValid {
lock(<span class="hljs-built_in" style="color: #c18401; line-height: 26px;">BOOL</span> va = _valid) <span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">return</span> va;
}
- (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)dealloc {
[<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">self</span> invalidate];
}
+ (<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span>)ss_executeBlockFromTimer:(SSTimer *)aTimer {
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">void</span> (^block)(SSTimer *) = [aTimer userInfo];
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">if</span> (block) block(aTimer);
}
<span class="hljs-keyword" style="color: #a626a4; line-height: 26px;">@end</span>
</code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-bottom: 8px; margin: 0; padding-top: 23px; color: rgb(74,74,74); line-height: 1.75em;">这里我们使用了<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">__weak id _target</code>,这样我们就内部就切断了这层循环引用问题，做到自主释放，外层使用方也不必关心，也不容易出现错误和内存泄漏.
具体的代码在<a href="https://github.com/SanLiangSan/SSTimer" target="_blank" rel="noopener" style="word-wrap: break-word; font-weight: bold; color: rgb(60, 112, 198); text-decoration: none; border-bottom: 1px solid rgb(60, 112, 198);">SSTimer下载</a>,需要的可以前去查看，目前内部也只是定义在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">main queue</code>上执行任务，后续会添加关于不同<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">queue</code>上执行任务的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(60, 112, 198);">timer</code>方法。还请不吝赐教和点赞支持，谢谢。</p>
</section>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://yoursite.com/2020/03/01/Dispatch-Source%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89Time/" data-id="ck795nbr10000ga3fbuhs3w6j" class="article-share-link">
                                            Share
                                        </a>
                                        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GCD/" rel="tag">GCD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ios/" rel="tag">ios</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/objc/" rel="tag">objc</a></li></ul>

                                    </footer>

    </div>

    

                

</article>
        
          <article id="post-KVC原理与自定义" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>

    <div class="article-inner">
        
            <header class="article-header">
                
  
    <h2 itemprop="name">
      <a class="article-title" href="/2020/03/01/KVC%E5%8E%9F%E7%90%86%E4%B8%8E%E8%87%AA%E5%AE%9A%E4%B9%89/">KVO原理分析</a>
    </h2>
  
  




            </header>
            

                
                    <div class="article-meta">
                        <a href="/2020/03/01/KVC%E5%8E%9F%E7%90%86%E4%B8%8E%E8%87%AA%E5%AE%9A%E4%B9%89/" class="article-date">
  <time datetime="2020-03-01T12:51:20.000Z" itemprop="datePublished">2020-03-01</time>
</a>
                            
                    </div>
                    

                        

                                    <div class="article-entry" itemprop="articleBody">
                                        


                                            

                                                
                                                                    <img src="https://user-gold-cdn.xitu.io/2020/2/18/17058a4859b8f2a6?w=900&amp;h=383&amp;f=jpeg&amp;s=129582" alt style="border-radius: 0px 0px 5px 5px; display: block; margin: 20px auto; width: 85%; height: 100%; object-fit: contain; box-shadow: #84A1A8 0px 10px 15px;">
<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: PingFangSC-Light;"><pre data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;">
<code style="display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">从几个面试题出发：
1.KVO的底层是如何实现的？
2.addObserver:forKeyPath:options:context:的context有什么用？
3.直接修改成员变量会触发KVO吗？
4.我们知道KVC会修改成员变量，那么它会触发KVO吗？
5.如何监听可变数组的内容修改？
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">看到上述问题，你有答案了吗？如果你有疑惑，带着疑问我们开启一段KVO的探索之旅。
</p>

<h2 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 24px; text-align: left; margin: 20px 10px 0px 0px;"><span style="font-family: STHeitiSC-Light; font-size: 18px; font-weight: bolder; display: inline-block; padding-left: 10px; border-left: 5px solid rgb(248,57,41);">1、KVO简介</span></h2>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>全称<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">Key-Value Observing</code>，是苹果提供的一套事件通知机制，允许一个对象在其他对象的指定属性发生更改时得到通知的机制。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 24px; text-align: left; margin: 20px 10px 0px 0px;"><span style="font-family: STHeitiSC-Light; font-size: 18px; font-weight: bolder; display: inline-block; padding-left: 10px; border-left: 5px solid rgb(248,57,41);">2、KVO初探</span></h2>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">大家都了解<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的基本使用方法，无非就是添加观察者、接收通知和移除观察者，下面我们通过一个简单的Demo来了解一下具体的实现。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">2.1 KVO的简单使用</span></h3>

<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#import <span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"ViewController.h"</span>
</span>
<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#import <span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"SSBoy.h"</span>
</span>
<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#import <span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"SSGirl.h"</span></span>
<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">
#import <span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">&lt;objc/runtime.h&gt;
</span>
</span>

<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">@interface</span> <span class="hljs-title" style="color: #e6c07b; line-height: 26px;">ViewController</span> ()</span>
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
@property</span> (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">nonatomic</span>, <span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">strong</span>) SSBoy *boy;
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">@property</span> (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">nonatomic</span>, <span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">strong</span>) SSGirl *girl;
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">@end</span>

<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">@implementation</span> <span class="hljs-title" style="color: #e6c07b; line-height: 26px;">ViewController</span></span>

- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)viewDidLoad {
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">super</span> viewDidLoad];
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy = [SSBoy new];
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.girl = [SSGirl new];
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 添加观察者</span>
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy addObserver:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span> forKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"name"</span> options:<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">NULL</span>];
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy addObserver:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span> forKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"age"</span> options:<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">NULL</span>];
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.girl addObserver:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span> forKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"name"</span> options:<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueObservingOptionNew</span> context:<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">NULL</span>];
}

- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)touchesBegan:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSSet</span>&lt;<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">UIEvent</span> *)event {
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 修改相应的值</span>
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
self</span>.boy.name = <span class="hljs-string" style="color: #98c379; line-height: 26px;">@"sanliangsan"</span>;
}

- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)observeValueForKeyPath:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSString</span> *)keyPath ofObject:(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">id</span>)object change:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSDictionary</span>&lt;<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueChangeKey</span>,<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">id</span>&gt; *)change context:(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span> *)context {
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 接收通知回调</span>
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
if</span> ([object isEqual:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy]) {
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span> ([keyPath isEqualToString:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"name"</span>]) {
<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSLog</span>(<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"boy change"</span>);
}
} <span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">else</span> {
<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSLog</span>(<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"girl change"</span>);
}
}
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">@end</span>

</code></pre>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">2.1 问题所在？</span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">上述代码清晰标注了<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的简单实现，不过这份简单代码有一些问题哦？那么问题在哪呢？</p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">1.<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">boy</code>和<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">girl</code>同时观察了相同的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">name</code>属性，我们的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">observeValueForKeyPath</code>方法的接收中多层的嵌套判断比较复杂，而且还容易出错，这就引出了上述关于<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">context</code>的面试题，我们引用一段官方文档：</p>
<pre data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code style="display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">    You may specify NULL and rely entirely on the key path string
to determine the origin of a change notification, but this
approach may cause problems for an object whose superclass is
also observing the same key path for different reasons.
A safer and more extensible approach is to use the context to
ensure notifications you receive are destined for your
observer and not a superclass
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">我们可以指定<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">NULL</code>作为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">context</code>，但是这样会因为一些不同的原因导致对象的父类也同时会观察相同的属性<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">key</code>，使用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">context</code>可以更安全以及更具有扩展性。同时也告知了我们<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">context</code>如果为空应该是用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">NULL</code> 而非<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">nil</code>。</p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">Context</code>具体如何使用呢</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 定义context</span>
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
static</span> <span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span> *BoyNameContext = &amp;BoyNameContext;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">
// 添加观察者</span>
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy addObserver:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span> forKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"name"</span>options:<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueObservingOptionNew</span> context:BoyNameContext];
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 接收通知回调</span>
- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)observeValueForKeyPath:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSString</span> *)keyPath ofObject:(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">id</span>)object change:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSDictionary</span>&lt;<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueChangeKey</span>,<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">id</span>&gt; *)change context:(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span> *)context {
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span> (context == BoyNameContext) {
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// do....</span>
}
}
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">Context</code>你会用了吗？聪明的你可能还发现了最上面的简单例子还有一个致命的问题？</p>

<p><img src="https://user-gold-cdn.xitu.io/2020/2/26/1707d26247552d1d?w=300&h=264&f=jpeg&s=9369" alt=""></p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">正是：我们没有对相应观察者进行移除，在我们的观察者释放的时候我们要移除相应观察。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)dealloc {
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy removeObserver:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span> forKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"name"</span> context:BoyNameContext];
}
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">如果观察的对象是一个单例，而他在几个不同的场景都有观察同样的属性，那么在某个场景消失的时候别的地方触发属性修改就会导致单例去寻找已经释放的对象，就是野指针的情况。具体的实现还请各位自己去测试。到此<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的简单实现你会了吗？</p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">接下来我们看看<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>底层到底是如何实现的。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 24px; text-align: left; margin: 20px 10px 0px 0px;"><span style="font-family: STHeitiSC-Light; font-size: 18px; font-weight: bolder; display: inline-block; padding-left: 10px; border-left: 5px solid rgb(248,57,41);">3、KVO底层原理</span></h2>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">3.1 动态子类</span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">我们依旧来一段文档引出我们今天的核心原理：</p>
<pre data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code style="display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">    Automatic key-value observing is implemented using a technique 
called isa-swizzling.
When an observer is registered for an attribute of an object
the isa pointer of the observed object is modified, pointing
to an intermediate class rather than at the true class. As a
result the value of the isa pointer does not necessarily
reflect the actual class of the instance.
You should never rely on the isa pointer to determine class
membership. Instead, you should use the class method to
determine the class of an object instance.
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>底层的实现是运用了一项 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">isa-swizzling</code> 的技术,当我们添加观察者的时候，系统动态的给我们的对象创建了一个子类，将对象的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">isa</code>指向了动态子类，而<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的所有实现都是通过这个动态子类的，添加一个动态子类让类的职责更单一具体，而且让我们的<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>透明化，创建动态子类的过程我们是无法感知的，同时我们也知道了获取一个类不能通过<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">isa</code>的指向而是要看<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">class</code>的方法返回。多说无益，我们验证一下：</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px;"><img src="https://user-gold-cdn.xitu.io/2020/2/19/170594af541ae63c?w=1682&amp;h=894&amp;f=png&amp;s=212830" alt style="border-radius: 0px 0px 5px 5px; display: block; margin: 20px auto; width: 85%; height: 100%; object-fit: contain; box-shadow: #84A1A8 0px 10px 15px;"></figure>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">还是同样的代码，我们看到添加观察者之前，<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">isa</code>指向<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">SSBoy</code>，但是添加观察者之后就指向一个叫<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">NSKVONotifying_SSBoy</code>的类，这正好验证了上述文档所说。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">3.1 成员变量和属性</span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;"><code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>到底研究的是什么？

<p><img src="https://user-gold-cdn.xitu.io/2020/2/26/1707d2852be40b9d?w=340&h=334&f=png&s=36506" alt=""></p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">
说到属性，我们无不和实例变量牵扯到一起，他们之间的区别就是是否有<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">setter</code>方法，属性的修改我们在最初已经验证过了，现在我们看看修改实例变量是否会触发<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 实例变量</span>
<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
@interface</span> <span class="hljs-title" style="color: #e6c07b; line-height: 26px;">SSBoy</span> : <span class="hljs-title" style="color: #e6c07b; line-height: 26px;">NSObject</span></span>
{
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">@public</span>
<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">
NSString</span> *nickName;
}

<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">
// 添加观察者</span>
[<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span>.boy addObserver:<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">self</span> forKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"nickName"</span> options:<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueObservingOptionNew</span> context:BoyNameContext];

<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">
// 修改实例变量</span>
- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)touchesBegan:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSSet</span>&lt;<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">UIEvent</span> *)event {
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 修改相应的值</span>
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
self</span>.boy-&gt;nickName = <span class="hljs-string" style="color: #98c379; line-height: 26px;">@"sanliangsan"</span>;
}
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 没有响应</span>
- (<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>)observeValueForKeyPath:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSString</span> *)keyPath ofObject:(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">id</span>)object change:(<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSDictionary</span>&lt;<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">NSKeyValueChangeKey</span>,<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">id</span>&gt; *)change context:(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span> *)context {
<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">// 接收通知回调</span>
<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">
if</span> (context == BoyNameContext) {
}
}
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">最终我们的结果是不会触发，那么为什么成员变量的修改不会触发<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>，动态子类究竟都干了啥？</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">3.3 动态子类做了啥？</span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">了解一个类我们无非是从属性，成员变量，方法等去研究，这里我们从方法入手，其他的大家可以下去一一验证。</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px;"><img src="https://user-gold-cdn.xitu.io/2020/2/19/1705979d2cc39ecc?w=1692&amp;h=1176&amp;f=png&amp;s=393169" alt style="border-radius: 0px 0px 5px 5px; display: block; margin: 20px auto; width: 85%; height: 100%; object-fit: contain; box-shadow: #84A1A8 0px 10px 15px;"></figure>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">我们去打印原类和动态子类的所有方法作以对比。</p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">1.<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">NSKVONotifying_SSBoy</code>中为啥没有setAge？</p>
<pre data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code style="display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">因为没有针对age添加观察者，这也证明了KVO的动态中间子类是通过实现setter方法去实现的。
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">2.<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">NSKVONotifying_SSBoy</code>中为啥有class方法？</p>
<pre data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code style="display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">重写class方法，因为class指向类本身，【伪装】为了让这一层更透明，苹
果重写class方法重新指向SSBoy，让上层对动态子类的生成没有感知，透明化&amp;隐私化
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">3.<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">dealloc</code>方法为了啥？</p>
<pre data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code style="display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">最初我们已经了解了，在添加观察者的时候会动态生成子类，而且对
象的isa会指向动态子类，当动态子类调用dealloc的时候，isa当然会重新指向回原类。
</code></pre>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">3.4 KVO与KVC</span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">之前的一篇文章  <a href="https://juejin.im/post/5e45360d51882549755810e8" target="_blank" rel="noopener" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: rgb(248,57,41); border-bottom: 1px solid #ff3502; font-family: STHeitiSC-Light;">KVC原理与自定义</a> 有讲述<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVC</code>底层是如何一步一步实现修改对象的属性的，那么问题来了，<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVC</code>会触发<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>吗，仔细阅读<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>官方文档我们看到一段话：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">NSObject provides a basic implementation of automatic ke
y-value change notification. Automatic key-value change no
tification informs observers of changes made using key-val
ue compliant accessors, as well as the key-value coding me
thods. Automatic notification is also supported by the col
lection proxy objects returned by, for example, mutableAr
rayValueForKey:
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">大概意思就是<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">NSObject</code>提供了自动<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">key-value</code>观察的实现，而且通过<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">setter</code>方法和<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">key-value coding</code>方法是一样的，换言之：<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">key-value coding</code>也能实现自动<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>，同时文档还给出相关能触发<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的实例：</p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">Examples of method calls that cause KVO change notifications to be emitted</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">// Call the accessor method.
[account setName:@"Savings"];
// Use setValue:forKey:.
[account setValue:@"Savings" forKey:@"name"];
// Use a key path, where 'account' is a kvc-compliant property of 'document'.
[document setValue:@"Savings" forKeyPath:@"account.name"];
// Use mutableArrayValueForKey: to retrieve a relationship proxy object.
Transaction *newTransaction = &lt;#Create a new transaction for the account#&gt;;
NSMutableArray *transactions = [account mutableArrayValueForKey:@"transactions"];
[transactions addObject:newTransaction];
</code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">通过以上我们得知：<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVC</code>是能自动实现<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的，而且可以验证不论是否有某属性都会自动通知到观察者。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 20px;"><span style="font-size: 14px; color: rgb(165,213,93);">3.5 KVO与可变数组</span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">我们在某些情况下想对一个数组进行观察，添加、删除，修改等等，但是实际测试发现，普通的方法调用并不会触发<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>，其原因很简单，利用我们上述的原理就得以解释：我们对数组的各种添加、删除、修改并不会调用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">setter</code>方法，由于<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVC</code>会触发<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>我们在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVC</code>里边找到相关的方法得以实现：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">[[_arrayModel mutableArrayValueForKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"dataArray"</span>] addObject:XXX];
[[_arrayModel mutableArrayValueForKeyPath:<span class="hljs-string" style="color: #98c379; line-height: 26px;">@"dataArray"</span>] removeObject:XXX];
</code></pre>
<h2 data-tool="mdnice编辑器" style="margin-top: 40px; margin-bottom: 20px; font-weight: bold; color: black; font-size: 24px; text-align: left; margin: 20px 10px 0px 0px;"><span style="font-family: STHeitiSC-Light; font-size: 18px; font-weight: bolder; display: inline-block; padding-left: 10px; border-left: 5px solid rgb(248,57,41);">4.总结</span></h2>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; color: black; margin: 10px 10px; line-height: 1.75; letter-spacing: 0.2em; font-size: 14px; word-spacing: 0.1em;">至此，我们对<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: rgb(271,93,108);">KVO</code>的简单使用以及原理分析已经完结，那些面试题的答案你都知晓了吗？实际的使用过程中我们还会碰到更多的问题，期待你的交流和沟通。</p>
</section>

                                                                        
                                    </div>
                                    <footer class="article-footer">
                                        <a data-url="http://yoursite.com/2020/03/01/KVC%E5%8E%9F%E7%90%86%E4%B8%8E%E8%87%AA%E5%AE%9A%E4%B9%89/" data-id="ck795nbr70001ga3fbdus3g5s" class="article-share-link">
                                            Share
                                        </a>
                                        
                                    </footer>

    </div>

    

                

</article>
        
    </article>
    
  
    
  </section>
</div>

  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-bar-chart"></i> <span id="busuanzi_value_site_pv"></span></li>
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 sanliangsan的博客</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean" target="_blank" rel="noopener">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="sanliangsan的博客"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">主页</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">归档</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">相册</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">关于</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/links">链接</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>

<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>






<script src="/js/ocean.js"></script>


</body>
</html>